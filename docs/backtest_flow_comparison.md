# PyTAAA Backtest Compute Flow Comparison

This table compares the compute flow for a backtest using parameters from a JSON file, as implemented in two entry points:

- **pytaaa_main.py** (calls run_pytaaa)
- **pytaaa_backtest_montecarlo.py** (CLI Monte Carlo tool)

The flow starts from reading `adjClose`, `symbols`, and `datearray` from the HDF5 data store and ends when the traded portfolio value history is written to a params file.

| Step | Description | pytaaa_main.py | pytaaa_backtest_montecarlo.py | File/Line (main) | File/Line (montecarlo) | Same/Different |
|------|-------------|---------------|-------------------------------|------------------|------------------------|---------------|
| **1. Load JSON config** | Load all parameters from JSON file | `params = get_json_params(json_fn, verbose=True)` | `params = get_json_params(json_fn, verbose=True)` | [run_pytaaa.py#L44](run_pytaaa.py#L44) | [functions/backtesting/monte_carlo_runner.py#L431](functions/backtesting/monte_carlo_runner.py#L431) | **Same** |
| **2. Get symbols file** | Resolve HDF5 symbols file path from config | `symbols_file = get_symbols_file(json_fn)` | `symbols_file = params["symbols_file"]` | [run_pytaaa.py#L45](run_pytaaa.py#L45) | [functions/backtesting/monte_carlo_runner.py#L432](functions/backtesting/monte_carlo_runner.py#L432) | **Same** |
| **3. Load adjClose, symbols, datearray** | Read price history from HDF5 store | `adjClose, symbols, datearray = load_quotes_for_analysis(symbols_file, json_fn, verbose=False)` | `adjClose, symbols, datearray = load_quotes_for_analysis(symbols_file, json_fn, verbose=True)` | [run_pytaaa.py#L96](run_pytaaa.py#L96) | [functions/backtesting/monte_carlo_runner.py#L434](functions/backtesting/monte_carlo_runner.py#L434) | **Same** |
| **4. Preprocess/clean data in loader** | NaN-fill, trim, align inside `load_quotes_for_analysis` | Same function called in both flows | Same function called in both flows | [functions/data_loaders.py#L50-L83](functions/data_loaders.py#L50-L83) | [functions/data_loaders.py#L50-L83](functions/data_loaders.py#L50-L83) | **Same** |
| **5a. Despike price data** | Apply `despike_2D` to detect and zero out interpolated/anomalous prices. Produces `adjClose_despike`. | `adjClose_despike = despike_2D(adjClose, LongPeriod, stddevThreshold=stddevThreshold)` — called inside `compute_portfolio_metrics` | **NOT DONE** — raw `adjClose` is used directly; no despiking is applied before `gainloss` or signal computation | [functions/output_generators.py#L682](functions/output_generators.py#L682) | [functions/backtesting/monte_carlo_runner.py#L439](functions/backtesting/monte_carlo_runner.py#L439) | **⚠️ DIFFERENT** |
|  | | | | | | **This is the most likely source of result differences.** The main flow removes interpolated price data before all downstream calculations. The Monte Carlo flow does not — it uses the raw `adjClose` for `gainloss`, `monthgainloss`, signal generation, and weights. Any stock with interpolated prices (e.g., JEF 2015–2018) will produce different signals and weights in each flow. |
| **5b. Build `gainloss` array** | Compute daily gain/loss ratios: `gainloss[:,1:] = prices[:,1:] / prices[:,:-1]` | Computed from **despiked** `adjClose_despike`: `gainloss[:,1:] = adjClose_despike[:,1:] / adjClose_despike[:,:-1]` then NaN/Inf → 1.0 | Computed from **raw** `adjClose`: `gainloss[:,1:] = adjClose[:,1:] / adjClose[:,:-1]` then NaN → 1.0 (no Inf guard) | [functions/output_generators.py#L686-L690](functions/output_generators.py#L686) | [functions/backtesting/monte_carlo_runner.py#L439-L441](functions/backtesting/monte_carlo_runner.py#L439) | **⚠️ DIFFERENT** |
|  | | | | | | Input prices differ (despiked vs raw). Monte Carlo also skips the `np.isinf` guard. |
| **5c. Build `value` array (cumulative buy-hold)** | `value = 10000 * cumprod(gainloss, axis=1)` — used later for rebalancing | `value = 10000. * np.cumprod(gainloss, axis=1)` (from despiked) | `value = 10000.0 * np.cumprod(gainloss, axis=1)` (from raw) | [functions/output_generators.py#L691](functions/output_generators.py#L691) | [functions/backtesting/monte_carlo_runner.py#L443](functions/backtesting/monte_carlo_runner.py#L443) | **⚠️ DIFFERENT** (inherits input difference from 5b) |
| **5d. Build `activeCount` array** | Count number of active (non-empty) stocks per day | Same formula in both, but applied to despiked vs raw gainloss | Same formula in both, but applied to raw gainloss | [functions/output_generators.py#L695-L706](functions/output_generators.py#L695) | [functions/backtesting/monte_carlo_runner.py#L445-L451](functions/backtesting/monte_carlo_runner.py#L445) | **⚠️ DIFFERENT** (inherits input difference) |
| **6a. Build `monthgainloss` array** | `monthgainloss[:,LongPeriod:] = prices[:,LongPeriod:] / prices[:,:-LongPeriod]` | Uses **despiked** `adjClose_despike` | Uses **raw** `adjClose` (via `execute_single_backtest`) | [functions/output_generators.py#L712-L714](functions/output_generators.py#L712) | [functions/backtesting/core_backtest.py#L402-L404](functions/backtesting/core_backtest.py#L402) | **⚠️ DIFFERENT** (despiked vs raw) |
| **6b. Compute `signal2D` — uptrend signals** | Call `computeSignal2D(prices, gainloss, params)` | Uses **despiked** `adjClose_despike` and despiked `gainloss` | Uses **raw** `adjClose` and raw `gainloss`; `uptrendSignalMethod` now read from JSON via `uptrendSignalMethod` argument ✅ (bug fixed 2026-02-27) | [functions/output_generators.py#L720-L730](functions/output_generators.py#L720) | [functions/backtesting/core_backtest.py#L407-L445](functions/backtesting/core_backtest.py#L407) | **⚠️ DIFFERENT** (input data only) |
|  | | | | | | Input data still differs (despiked vs raw). **Bug fixed:** `signal_params` dict at [core_backtest.py#L413](functions/backtesting/core_backtest.py#L413) previously hardcoded `'uptrendSignalMethod': 'percentileChannels'` — the JSON value was silently ignored even though it was logged. Now uses `uptrendSignalMethod` argument (read from JSON at [core_backtest.py#L877](functions/backtesting/core_backtest.py#L877)) and reads `narrowDays`/`mediumDays`/`wideDays` from `validated_params` instead of dummy values. **Re-run backtests for all models that use a non-`percentileChannels` signal method.** |
| **6c. Apply SP500 pre-2002 signal constraint** | Zero signals for all stocks before 2002-01-01 when `stockList == 'SP500'` | Applied after `computeSignal2D`, before rolling filter | Applied after `computeSignal2D`, before rolling filter | [functions/output_generators.py#L732-L740](functions/output_generators.py#L732) | [functions/backtesting/core_backtest.py#L468-L472](functions/backtesting/core_backtest.py#L468) | **Same** |
| **6d. Apply rolling window data quality filter** | `apply_rolling_window_filter(prices, signal2D, window_size, ...)` — further zeroes signals for interpolated data | Applied to `adjClose_despike` (already despiked) | Applied to raw `adjClose` | [functions/output_generators.py#L745-L755](functions/output_generators.py#L745) | [functions/backtesting/core_backtest.py#L476-L487](functions/backtesting/core_backtest.py#L476) | **⚠️ DIFFERENT** (input differs) |
| **6e. Forward-fill signals by `monthsToHold`** | Hold signal constant within each hold period | Same logic in both | Same logic in both | [functions/output_generators.py#L759-L763](functions/output_generators.py#L759) | [functions/backtesting/core_backtest.py#L494-L498](functions/backtesting/core_backtest.py#L494) | **Same** |
| **7a. Compute weights — `sharpeWeightedRank_2D`** | `monthgainlossweight = sharpeWeightedRank_2D(json_fn, datearray, symbols, prices, signal2D, signal2D_daily, ...)` | Uses despiked `adjClose_despike`; calls with `is_backtest=False, makeQCPlots=True`; no weight constraint params | Uses raw `adjClose`; calls with `max_weight_factor`, `min_weight_factor`, `absolute_max_weight`, `apply_constraints` from params | [functions/output_generators.py#L801-L809](functions/output_generators.py#L801) | [functions/backtesting/core_backtest.py#L543-L557](functions/backtesting/core_backtest.py#L543) | **⚠️ DIFFERENT** |
|  | | | | | | Main flow does not pass weight constraint params (uses defaults inside `sharpeWeightedRank_2D`). Monte Carlo flow passes them explicitly. Input prices also differ (despiked vs raw). |
| **7b. Compute traded portfolio value (`monthvalue`)** | Rebalance on each hold-period boundary using `monthgainlossweight * valuesum * gainloss[jj,ii]`; otherwise carry forward | Both use the same rebalancing formula | Both use the same rebalancing formula | [functions/output_generators.py#L824-L835](functions/output_generators.py#L824) | [functions/backtesting/core_backtest.py#L580-L591](functions/backtesting/core_backtest.py#L580) | **Same formula** ⚠️ but results differ because `gainloss` and `monthgainlossweight` inputs differ |
| **8. Write portfolio value history to `.params` file** | `_write_daily_backtest` → `computeDailyBacktest` → writes `pyTAAAweb_backtestPortfolioValue.params` | Writes `.params` file only for last trial; format: JSON lines with date, buy-and-hold, traded values | [functions/PortfolioPerformanceCalcs.py#L99-L165](functions/PortfolioPerformanceCalcs.py#L99) [functions/dailyBacktest.py#L511-L550](functions/dailyBacktest.py#L511) | [pytaaa_backtest_montecarlo.py#L185-L211](pytaaa_backtest_montecarlo.py#L185) | **⚠️ DIFFERENT** |
|  | | | | | | Main flow writes via `computeDailyBacktest` (legacy path). Monte Carlo writes directly inline for the last trial only. Output file names and formats may also differ. |

**Summary of where results diverge:**
- **Step 5a** is the root cause: the main flow despiked `adjClose` before everything else; the Monte Carlo flow does not. All downstream arrays (`gainloss`, `monthgainloss`, `signal2D`, `monthgainlossweight`, `monthvalue`) are affected.
- **Step 6b** ✅ Bug fixed 2026-02-27: Monte Carlo previously hardcoded `uptrendSignalMethod='percentileChannels'`; now correctly uses the value from the JSON. `narrowDays`/`mediumDays`/`wideDays` also now read from `validated_params`. **Re-run backtests for all models that use a non-`percentileChannels` signal method.**
- **Step 7a** also diverges independently: Monte Carlo passes explicit weight constraint parameters; the main flow does not.
- Steps 1–4, 6c, 6e are the same in both flows.

---

## Quick-Reference: Where Results Diverge

| Step | Root difference |
|------|----------------|
| **5a** ⚠️ Root cause | Main flow runs `despike_2D(adjClose, LongPeriod, stddevThreshold)` → produces `adjClose_despike`. Monte Carlo flow skips this entirely — uses raw `adjClose` throughout. All downstream arrays are affected. |
| **5b** | `gainloss` is built from despiked prices in main; raw prices in Monte Carlo. Monte Carlo also skips the `np.isinf` guard. |
| **5c–5d, 6a** | `value`, `activeCount`, `monthgainloss` all inherit the 5a/5b price difference. |
| **6b** ✅ Fixed | Bug fixed 2026-02-27: `signal_params` dict now uses `uptrendSignalMethod` from the JSON argument instead of hardcoding `'percentileChannels'`. Also reads `narrowDays`/`mediumDays`/`wideDays` from `validated_params`. Remaining difference: input prices (despiked vs raw). Re-run backtests for models that use a non-`percentileChannels` signal method. |
| **6d** | Rolling window filter is applied to despiked prices in main vs raw prices in Monte Carlo. |
| **7a** | Main flow calls `sharpeWeightedRank_2D` without explicit weight constraint params (uses function defaults); Monte Carlo passes `max_weight_factor`, `min_weight_factor`, `absolute_max_weight`, `apply_constraints` explicitly. |
| **7b, 8** | Rebalancing formula is identical, but results differ because `gainloss` and `monthgainlossweight` inputs differ. Output file paths/formats also differ. |
| **1–4, 6c, 6e** | Same in both flows. |

---

_Last updated: 2026-02-27_
